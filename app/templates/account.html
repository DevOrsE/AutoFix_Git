{% extends "base.html" %}
{% block title %}–ê–∫–∫–∞—É–Ω—Ç{% endblock %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<section class="account-section">
  <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.login }}!</h2>
  <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ user.phone or "–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
  <p><strong>–õ–æ–≥–∏–Ω:</strong> {{ user.login }}</p>

  <hr>
  <h3>–í–∞—à–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</h3>
{% if cars %}
  <ul class="list-group">
    {% for car in cars %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ car.model.name }}</strong><br>
          <small>–ù–æ–º–µ—Ä: {{ car.plate_number }} | –ì–æ–¥: {{ car.year }}</small><br>
          {% if car.note %}<small>–ó–∞–º–µ—Ç–∫–∞: {{ car.note }}</small>{% endif %}
        </div>
        <div>
          <a href="{{ url_for('cars.edit_car', car_id=car.id) }}" class="btn btn-sm btn-warning">‚úèÔ∏è</a>
          <form method="POST" action="{{ url_for('cars.delete_car', car_id=car.id) }}" style="display:inline;">
            {{ delete_forms[car.id].hidden_tag() }}
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ?')">üóëÔ∏è</button>
          </form>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.</p>
{% endif %}


  <hr>
  <hr>
  <h3>–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</h3>
<form method="POST">
  {{ form.hidden_tag() }}

  <div class="mb-3">
    {{ form.model_id.label(class="form-label") }}
    {{ form.model_id(class="form-select") }}
  </div>

  <div class="mb-3">
    {{ form.plate_number.label(class="form-label") }}
    {{ form.plate_number(class="form-control") }}
  </div>

  <div class="mb-3">
    {{ form.year.label(class="form-label") }}
    {{ form.year(class="form-control") }}
  </div>

  <div class="mb-3">
    {{ form.note.label(class="form-label") }}
    {{ form.note(class="form-control") }}
  </div>

  {{ form.submit(class="btn btn-success") }}
</form>

</section>

<hr class="mt-5 mb-4">
<h3 class="text-center mb-4">üõ† –í–∞—à–∏ –∑–∞–∫–∞–∑—ã</h3>

{% if orders %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
    {% for order in orders %}
      <div class="col">
        <div class="card border-primary shadow-sm h-100">
          <div class="card-header bg-primary text-white d-flex justify-content-between">
            <div>
              üöó {{ order.car.model.name }}<br>
              <small>{{ order.car.plate_number }}</small>
            </div>
            <small>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
          </div>

          <div class="card-body">
            {% for item in order.items %}
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <strong>{{ item.service_type.name }}</strong>
                  {% if item.part %}
                    <br><small class="text-muted">–¥–µ—Ç–∞–ª—å: {{ item.part.code }}</small>
                  {% endif %}
                </div>
                <strong>{{ item.price }} ‚ÇΩ</strong>
              </div>
            {% endfor %}

            <hr>
            <div class="d-flex justify-content-between">
              <span><strong>–ò—Ç–æ–≥–æ:</strong></span>
              <span><strong>{{ order.total_price }} ‚ÇΩ</strong></span>
            </div>
            {% if order.master_fee %}
              <small class="text-muted">–í–∫–ª—é—á–µ–Ω–æ: –Ω–∞—Ü–µ–Ω–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ {{ order.master_fee }} ‚ÇΩ</small>
            {% endif %}

            {% if order.fail_reason %}
              <div class="mt-3 text-danger">
                <strong>‚ùå –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong>
                <div>{{ order.fail_reason }}</div>
              </div>
            {% endif %}
          </div>

          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              <strong>–°—Ç–∞—Ç—É—Å:</strong>
              {% if order.status == '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' %}
                <span class="badge bg-success">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
              {% elif order.status == '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ' %}
                <span class="badge bg-danger">–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ</span>
              {% else %}
                <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç</span>
              {% endif %}
            </div>
            <a href="{{ url_for('main.order_receipt_pdf', order_id=order.id) }}" class="btn btn-outline-success mt-2">
              –û–ø–ª–∞—Ç–∞
            </a>

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted text-center">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>
{% endif %}



{% endblock %}